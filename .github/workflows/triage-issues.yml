name: ðŸŽª Festival Feedback Triage

on:
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write

env:
  OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
  ISSUE_NUMBER: ${{ github.event.issue.number }}
  GH_TOKEN: ${{ github.token }}

jobs:
  triage:
    name: ðŸ¤– Goose Issue Triage
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Gather issue information
        run: |
          {
            echo "# Issue Details"
            echo "**Number:** ${{ github.event.issue.number }}"
            echo "**Title:** ${{ github.event.issue.title }}"
            echo ""
            echo "**Body:**"
            echo "${{ github.event.issue.body }}"
          } > issue_info.txt

      - name: Install goose CLI
        run: |
          mkdir -p /home/runner/.local/bin
          curl -fsSL https://github.com/block/goose/releases/download/stable/download_cli.sh \
            | CONFIGURE=false GOOSE_BIN_DIR=/home/runner/.local/bin bash
          echo "/home/runner/.local/bin" >> $GITHUB_PATH

      - name: Configure goose
        run: |
          mkdir -p ~/.config/goose
          cat <<EOF > ~/.config/goose/config.yaml
          GOOSE_PROVIDER: openrouter
          GOOSE_MODEL: anthropic/claude-opus-4
          keyring: false
          extensions:
            developer:
              enabled: true
              name: developer
              type: builtin
          EOF

      - name: Create instructions for goose
        run: |
          cat <<EOF > instructions.txt
          You are a festival feedback triage assistant. Analyze this GitHub issue and take action using the shell tool.

          $(cat issue_info.txt)

          ## Your Tasks

          1. **Analyze** the issue to determine:
             - **Category:** bug, feature, question, or urgent
             - **Priority:** high, medium, or low
             - **Sentiment:** positive, negative, or neutral

          2. **Apply labels** using gh CLI. Pick the appropriate labels:
             - \`urgent\` - for critical/emergency issues
             - \`bug\` - for things not working
             - \`feature\` - for suggestions/requests  
             - \`question\` - for questions
             - \`priority: high\` - needs immediate attention
             - \`priority: medium\` - should address soon
             - \`priority: low\` - can wait
             - \`sentiment: positive\` - positive feedback
             - \`sentiment: negative\` - negative feedback
             - \`sentiment: neutral\` - neutral feedback
             - \`triaged\` - always add this to mark as processed

             Use the shell tool to run: gh issue edit $ISSUE_NUMBER --add-label "label1,label2,label3"

          3. **Add a helpful comment** to the issue using the shell tool:
             - Acknowledge the feedback with a friendly greeting
             - Explain what category and priority was assigned
             - Provide helpful next steps or information
             - Use emojis for visual appeal ðŸŽªâ„ï¸âœ¨ðŸš¨

             Use the shell tool to run: gh issue comment $ISSUE_NUMBER --body "Your comment here"

          IMPORTANT: Use the shell tool to execute the gh commands. The GH_TOKEN environment variable is already set.
          EOF

      - name: Run goose to triage issue
        run: |
          goose run --instructions instructions.txt 2>&1 | \
            # Remove ANSI color codes
            sed -E 's/\x1B\[[0-9;]*[mK]//g' | \
            # Remove session/logging lines
            grep -v "logging to /home/runner/.config/goose/sessions/" | \
            grep -v "^starting session" | \
            grep -v "^Closing session" | \
            # Trim trailing whitespace
            sed 's/[[:space:]]*$//' \
            > goose_output.txt
          
          echo "=== Goose Output ==="
          cat goose_output.txt
