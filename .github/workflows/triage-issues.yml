name: ðŸŽª Festival Feedback Triage

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  triage:
    runs-on: ubuntu-latest
    name: ðŸ¤– Goose Issue Triage
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Install goose
        run: |
          curl -fsSL https://github.com/block/goose/releases/download/stable/download_cli.sh | CONFIGURE=false bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ðŸ·ï¸ Triage issue with goose
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Configure goose to use OpenRouter
          mkdir -p ~/.config/goose
          cat > ~/.config/goose/config.yaml << 'EOF'
          GOOSE_PROVIDER: openrouter
          GOOSE_MODEL: anthropic/claude-sonnet-4
          extensions:
            developer:
              enabled: true
          EOF
          
          export GOOSE_PROVIDER=openrouter
          export GOOSE_MODEL=anthropic/claude-sonnet-4
          
          # Create the triage instructions
          cat > /tmp/triage_instructions.md << 'INSTRUCTIONS'
          You are a festival feedback triage assistant. Analyze this GitHub issue and take action.

          ## Issue Details
          - **Number:** $ISSUE_NUMBER
          - **Title:** $ISSUE_TITLE
          - **Body:** $ISSUE_BODY

          ## Your Tasks

          1. **Analyze** the issue content to determine:
             - Category: Is it a bug, feature request, question, or urgent issue?
             - Priority: high, medium, or low
             - Sentiment: positive, negative, or neutral

          2. **Apply labels** using the gh CLI:
             ```
             gh issue edit $ISSUE_NUMBER --add-label "label1,label2"
             ```
             
             Available labels to apply (pick appropriate ones):
             - `urgent` - for critical/emergency issues
             - `bug` - for things not working
             - `feature` - for suggestions/requests
             - `question` - for questions
             - `priority: high` - needs immediate attention
             - `priority: medium` - should address soon
             - `priority: low` - can wait

          3. **Add a helpful comment** using:
             ```
             gh issue comment $ISSUE_NUMBER --body "Your comment here"
             ```
             
             Make the comment friendly and helpful with:
             - Acknowledge the feedback
             - Explain what category/priority was assigned
             - Provide relevant next steps or information
             - Use emojis for visual appeal ðŸŽªâ„ï¸âœ¨

          Use the shell tool to run the gh commands. The GITHUB_TOKEN is already configured.
          INSTRUCTIONS

          # Substitute environment variables
          envsubst < /tmp/triage_instructions.md > /tmp/triage_final.md
          
          # Run goose with the instructions
          goose run --text "$(cat /tmp/triage_final.md)"
